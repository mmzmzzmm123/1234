<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.PlayMapper">

    <select id="selectPage" resultType="com.ruoyi.system.domain.vo.play.QueryPlayVO">
        SELECT
            tpi.id,
            tpi.`name`,
            tpi.group_source,
            tpi.`state`,
            tpi.create_time,
            tmi.merchant_id,
            tmi.merchant_name
        FROM
            t_play_info tpi
            LEFT JOIN t_merchant_info tmi ON tpi.merchant_id = tmi.merchant_id
        WHERE
        1 = 1
        <if test="dto.merchantId != null and dto.merchantId != ''">
            AND tpi.merchant_id = #{dto.merchantId}
        </if>
        <if test="dto.startTime != null and dto.startTime != ''">
            AND tpi.create_time >= #{dto.startTime}
        </if>
        <if test="dto.endTime != null and dto.endTime != ''">
            AND tpi.create_time &lt;= #{dto.endTime}
        </if>
        <if test="dto.state != null">
            AND tpi.state = #{dto.state}
        </if>
        <if test="dto.queryType != null and dto.queryValue != null and dto.queryValue != ''">
            <choose>
                <when test="dto.queryType == 1">
                    AND tpi.name like concat('%',#{dto.queryValue},'%')
                </when>
                <when test="dto.queryType == 2">
                    AND tpi.id = #{dto.queryValue}
                </when>
                <when test="dto.queryType == 3">
                    AND tmi.merchant_id = #{dto.queryValue}
                </when>
                <when test="dto.queryType == 4">
                    AND tmi.merchant_name like concat('%',#{dto.queryValue},'%')
                </when>
            </choose>
        </if>
        order by tpi.create_time desc
    </select>

    <select id="selectTaskProgress" resultType="com.ruoyi.system.domain.vo.play.PlayTaskProgressVO">
        SELECT
            tpmp.play_id,
            count( 1 ) AS totalNum,
            sum( IF ( tpmpd.send_state > 0, 1, 0 ) ) AS currentNum,
            sum( IF ( tpmpd.send_state = 1, 1, 0 ) ) AS sendSuccessNum,
            sum( IF ( tpmpd.send_state = 2, 1, 0 ) ) AS sendFailNum
        FROM
            t_play_message_push tpmp
            LEFT JOIN t_play_message_push_detail tpmpd ON tpmp.id = tpmpd.play_msg_push_id
        WHERE
            tpmp.play_id IN
            <foreach collection="playIds" item="playId" open="(" separator="," close=")">
                #{playId}
            </foreach>
        GROUP BY
            tpmp.play_id
    </select>


    <select id="selectTaskGroupProgress" resultType="com.ruoyi.system.domain.vo.play.PlayTaskProgressVO">
        SELECT
            tpi.id AS playId,
            tpi.state,
            tpi.scan_progress,
            tpi.group_num AS groupTotalNum,
            sum( IF ( tgs.group_status = 1, 1, 0 ) ) AS groupFailNum,
            count( tpgi.group_id ) AS groupCurrentNum,
            count( tpmp.id ) AS packTotalNum,
            sum( IF ( tpmp.robot_pack_flag = 1, 1, 0 ) ) AS packCurrentNum,
            count( tpmp.id ) AS joinGroupTotalNum,
            sum( IF ( tpmp.send_flag = 1, 1, 0 ) ) AS joinGroupCurrentNum
        FROM
            t_play_info tpi
            LEFT JOIN t_play_group_info tpgi ON tpi.id = tpgi.play_id
            LEFT JOIN t_group_state tgs ON tpgi.tg_group_id = tgs.group_id
            LEFT JOIN t_play_message_push tpmp ON tpgi.play_id = tpmp.play_id and tpgi.tg_group_id = tpmp.group_id
        WHERE
            tpi.id IN
            <foreach collection="playIds" item="playId" open="(" separator="," close=")">
                #{playId}
            </foreach>
        GROUP BY
            tpi.id
    </select>

    <select id="selectGroupProgress" resultType="com.ruoyi.system.domain.vo.play.PlayGroupProgressVO">
        SELECT
            tpgi.group_id AS id,
            tpgi.play_id,
            tpgi.state,
            tpmp.id AS pushId,
            IFNULL( tpmp.push_state, 1 ) AS pushState,
            tgi.group_id,
            tgi.group_serial_no,
            tgi.group_name,
            tgi.group_remark,
            tgi.group_about,
            tgi.group_link,
            tgi.group_private_link,
            tgi.group_type,
            tgi.group_invite_link,
            tgmi.member_count,
            tgmi.join_count,
            tgmi.exit_count,
            tgmi.link_join_count,
            tgs.group_status,
            if(tgs.group_status = 0,null, tgs.group_status_time) group_status_time,
            (
                SELECT
                    count( 1 )
                FROM
                    t_play_robot_group_relation tprgr
                WHERE
                    tprgr.group_id = tgi.group_id
                  AND tprgr.state = 1
                  AND tprgr.is_delete = 0
            ) AS navyCount,
            count( tpmpd.id ) AS totalNum,
            sum( IF ( tpmpd.send_state > 0, 1, 0 ) ) AS currentNum,
            count( tpmpd.id ) - sum( IF ( tpmpd.send_state > 0, 1, 0 ) ) AS waitNum,
            sum( IF ( tpmpd.send_state = 1, 1, 0 ) ) AS successNum,
            sum( IF ( tpmpd.send_state = 2, 1, 0 ) ) AS failNum,
            tri.seal_status AS groupMasterSealStatus,
            tgs.upgrade_time,
           if( tgmi.original_group_id  like '-100%', 1,0 ) AS superGroup
        FROM
            t_play_group_info tpgi
            LEFT JOIN t_group_info tgi ON tpgi.tg_group_id = tgi.group_id
            LEFT JOIN t_group_monitor_info tgmi ON tgi.group_id = tgmi.group_id
            LEFT JOIN t_group_state tgs ON tgi.group_id = tgs.group_id
            LEFT JOIN t_group_robot tgr ON tgr.group_id = tgi.group_id
            AND tgr.member_type = 1
            LEFT JOIN t_robot_info tri ON tgr.robot_id = tri.robot_serial_no
            LEFT JOIN t_play_message_push tpmp ON tpgi.play_id = tpmp.play_id
            AND tpgi.tg_group_id = tpmp.group_id
            LEFT JOIN t_play_message_push_detail tpmpd ON tpmp.id = tpmpd.play_msg_push_id
        WHERE
            1 = 1
          AND tpgi.into_status in (1, 2)
          AND tpgi.play_id = #{playId}
        GROUP BY
            tpgi.group_id
        ORDER BY
            tpgi.create_time DESC,tpgi.group_id ASC
    </select>

    <select id="selectPushDetailPage" resultType="com.ruoyi.system.domain.vo.play.QueryPushDetailVO">
        SELECT
            tpmp.group_id,
            tgi.group_serial_no,
            tpmp.group_name,
            tpmpd.spokesman_nickname,
            tpmpd.robot_id,
            concat( tri.first_name, ' ', tri.last_name ) AS robotNickname,
            tri.head_img_url AS robotImgUrl,
            tpmpd.robot_acct,
            tpmpd.message_content,
            tpmpd.message_sort,
            tpmpd.send_state,
            tpmpd.modify_time as sendTime,
            tpmpd.create_time,
            tpmpd.push_fail_reason,
            tgr.bot_type,
            tgr.member_type
        FROM
            t_play_message_push tpmp
            LEFT JOIN t_play_message_push_detail tpmpd ON tpmp.id = tpmpd.play_msg_push_id
            LEFT JOIN t_group_info tgi ON tpmp.group_id = tgi.group_id
            LEFT JOIN t_robot_info tri ON tpmpd.robot_id = tri.robot_serial_no
            LEFT JOIN t_group_robot tgr ON tpmp.group_id = tgr.group_id
            AND tpmpd.robot_id = tgr.robot_id
        WHERE
            1 = 1
          AND tpmp.play_id = #{dto.playId}
        <choose>
            <when test="dto.timeType != null and dto.timeType == 2">
                <if test="dto.startTime != null and dto.startTime != ''">
                    and tpmpd.send_time >= #{dto.startTime}
                </if>
                <if test="dto.endTime != null and dto.endTime != ''">
                    and tpmpd.send_time &lt;= #{dto.endTime}
                </if>
            </when>
            <otherwise>
                <if test="dto.startTime != null and dto.startTime != ''">
                    and tpmpd.create_time >= #{dto.startTime}
                </if>
                <if test="dto.endTime != null and dto.endTime != ''">
                    and tpmpd.create_time &lt;= #{dto.endTime}
                </if>
            </otherwise>
        </choose>
        <if test="dto.sendState != null">
            and tpmpd.send_state = #{dto.sendState}
        </if>

        <if test="dto.robotId != null and dto.robotId != ''">
            and tpmpd.robot_id = #{dto.robotId}
        </if>
        <if test="dto.robotAcct != null and dto.robotAcct != ''">
            and tpmpd.robot_acct = #{dto.robotAcct}
        </if>
        <if test="dto.robotNickname != null and dto.robotNickname != ''">
            AND concat( tri.first_name, ' ', tri.last_name ) LIKE concat('%',#{dto.robotNickname},'%')
        </if>


        <if test="dto.groupId != null and dto.groupId != ''">
            and tpmp.group_id = #{dto.groupId}
        </if>
        <if test="dto.groupName != null and dto.groupName != ''">
            and tpmp.group_name = #{dto.groupName}
        </if>
        <if test="dto.groupSerialNo != null and dto.groupSerialNo != ''">
            and tgi.group_serial_no = #{dto.groupSerialNo}
        </if>

        ORDER BY
        <choose>
            <when test="dto.sortField != null and dto.sortField == 2">
                tpmpd.modify_time
            </when>
            <otherwise>
                tpmpd.create_time
            </otherwise>
        </choose>
        <choose>
            <when test="dto.sort != null and dto.sort == 1">
                ASC
            </when>
            <otherwise>
                DESC
            </otherwise>
        </choose>
    </select>

    <select id="selectIntoGroupList" resultType="com.ruoyi.common.core.domain.entity.play.Play">
        select * from t_play_info where state = #{state} and scan_progress = #{progress} and is_delete = 0
    </select>

    <select id="selectPlayById" resultType="com.ruoyi.common.core.domain.entity.play.Play">
     select * from t_play_info where id = #{playId}
    </select>


    <select id="selectConfusionStateStatistics" resultType="com.ruoyi.system.domain.vo.PlayConfusionStateVO">
        SELECT
            tpi.id AS playId,
            count( tpmc.id ) AS total,
            sum( IF ( tpmc.state = 1, 1, 0 ) ) AS successCount,
            sum( IF ( tpmc.state = 2, 1, 0 ) ) AS failCount
        FROM
            t_play_info tpi
                INNER JOIN t_play_message_confound tpmc ON tpi.id = tpmc.play_id
        WHERE
            1 = 1
          AND tpi.state = 1
          AND tpi.confound_state in (0, 3)
          AND tpi.is_confound = 1
          AND tpi.create_time > ADDDATE( NOW( ),- 3 )
        GROUP BY
            tpi.id
    </select>

    <select id="selectConfusionList" resultType="com.ruoyi.common.core.domain.entity.play.Play">
        SELECT
            tpi.id,
            tpi.name,
            tpi.state,
            tpi.scan_progress
        FROM
            t_play_info tpi
        WHERE
            1 = 1
          AND tpi.is_delete = 0
          AND tpi.state = 1
          AND scan_progress = 4
          AND confound_state = 0
          AND tpi.create_time > ADDDATE( NOW( ),- 3 )
        GROUP BY
            tpi.id
    </select>

    <select id="selectReleaseRobots" resultType="String">
        select tpi.id from t_play_info tpi
        left join t_play_repeat_log tprl on tpi.id = tprl.play_id
        where tpi.state in (4,5) and tpi.lock_robot_status=1 and tprl.play_id is null
        and tpi.end_date &gt;= #{startDate} and tpi.end_date &lt;= #{endDate}
    </select>
</mapper>