<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.PlayMessagePushMapper">


    <select id="getRobotStatisticsVO" resultType="com.ruoyi.system.domain.vo.play.RobotStatisticsVO">
        SELECT
            count( t1.id ) AS groupNum,
            sum( IF ( t2.group_status = 1, 1, 0 ) ) AS groupClosureNum,
            0 as joinGroupFailNum
        FROM
            t_play_message_push t1
            LEFT JOIN t_group_state t2 ON t1.group_id = t2.group_id
        WHERE
            t1.play_id = #{playId}
    </select>

    <select id="robotDetails" resultType="com.ruoyi.system.domain.vo.play.QueryRobotDetailVO">
        SELECT
            tri.country_code AS countryCode,
            tri.country AS countryName,
            count( tri.id ) AS robotTotalNUm,
            SUM( IF ( tri.seal_status = 10, 1, 0 ) ) AS robotSuccessNUm,
            SUM( IF ( tri.bidirectional_type = 1, 1, 0 ) ) AS bidirectionalNum,
            SUM( IF ( tri.seal_status = 30, 1, 0 ) ) AS closureNum,
            SUM( IF ( tri.heartbeat_status = 10, 1, 0 ) ) AS offlineNum,
            count( tpmpd.id ) AS sendTotalNUm,
            SUM( IF ( tpmpd.send_state = 1, 1, 0 ) ) AS sendSuccessNUm,
            SUM( IF ( tpmpd.send_state = 2, 1, 0 ) ) AS sendFailNUm
        FROM
            t_play_message_push tpmp
            LEFT JOIN t_play_message_push_detail tpmpd ON tpmp.id = tpmpd.play_msg_push_id
            LEFT JOIN t_robot_info tri ON tri.robot_serial_no = tpmpd.robot_id
        WHERE
            1 = 1
          AND tpmp.play_id = #{dto.playId}
          <if test="dto.countryName != null and dto.countryName != ''">
              AND tri.country = #{dto.countryName}
          </if>
        GROUP BY
            tri.country_code
    </select>
</mapper>
