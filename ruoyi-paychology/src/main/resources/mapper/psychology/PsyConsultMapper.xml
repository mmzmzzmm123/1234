<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.psychology.mapper.PsyConsultMapper">

    <select id="search" resultType="com.ruoyi.psychology.domain.PsyConsult">
        select id, user_id, user_name, nicK_name, avatar, email, phonenumber, sex, tabs, way, way_str, wx_card, zx_word, zx_style, notice, experience, info, detail, serve, work_num, work_time, work_hours, del_flag, status, qualification, index_qualification, create_by, create_time, update_by, update_time,
        qualification, index_qualification, mode, city, province, genre, img, share, lang,
        (SELECT count(id) FROM psy_consult_work WHERE `live` != '[]' and `live` != `used` and consult_id = psy_consult.id and `day` = DATE_FORMAT(NOW(),'%Y-%m-%d')) buy,
        (SELECT b.price FROM psy_consult_serve a INNER JOIN psy_consult_serve_config b ON a.serve_id=b.id AND a.consult_id=psy_consult.id WHERE b.bound = 0 ORDER BY b.price ASC LIMIT 1) price,
        (SELECT b.price FROM psy_consult_serve a INNER JOIN psy_consult_serve_config b ON a.serve_id=b.id AND a.consult_id=psy_consult.id WHERE b.bound = 1 ORDER BY b.price ASC LIMIT 1) new_price
        from psy_consult
        <where>
            and status = 0 and del_flag = 0
            <if test="userName != null  and userName != ''"> and user_name like concat('%', #{userName}, '%')</if>
            <if test="sex != null  and sex != ''"> and sex = #{sex}</if>
            <if test="city != null  and city != ''"> and city = #{city}</if>
            <if test="province != null  and province != ''"> and province = #{province}</if>
            <choose>
                <when test="nand != null and nand lt 1">
                    <if test="buy != null">
                        and (SELECT count(id) FROM psy_consult_work WHERE `live` != '[]' and `live` != `used` and consult_id = psy_consult.id and `day` = DATE_FORMAT(NOW(),'%Y-%m-%d')) <![CDATA[>]]> 0
                    </if>
                    and id in (
                    SELECT a.consult_id FROM psy_consult_serve a INNER JOIN psy_consult_serve_config b on a.serve_id = b.id WHERE a.consult_id = psy_consult.id
                    <if test="single != null"> and b.type = 1</if>
                    <if test="serveId != null  and serveId != ''"> and b.id = #{serveId}</if>
                    <if test="lowPrice != null and highPrice != null">
                        and b.price <![CDATA[>=]]> #{lowPrice} and b.price <![CDATA[<=]]> #{highPrice}
                    </if>
                    GROUP BY a.consult_id
                    )
                </when>
                <when test="nand != null and nand gt 0">
                    and (
                        <if test="(serveId != null  and serveId != '') or lowPrice != null or highPrice != null">
                            id in (
                            SELECT a.consult_id FROM psy_consult_serve a INNER JOIN psy_consult_serve_config b on a.serve_id = b.id and a.consult_id = psy_consult.id
                            <where>
                                <if test="single != null"> or b.type = 1</if>
                                <if test="serveId != null  and serveId != ''"> or b.id = #{serveId}</if>
                                <if test="lowPrice != null and lowPrice > 0">
                                    or b.price <![CDATA[>=]]> #{lowPrice}
                                </if>
                                <if test="highPrice != null and highPrice > 0">
                                    or b.price <![CDATA[<=]]> #{highPrice}
                                </if>
                            </where>
                            GROUP BY a.consult_id
                            )
                            <if test="buy != null">
                                or
                            </if>
                        </if>
                        <if test="buy != null">
                            (SELECT count(id) FROM psy_consult_work WHERE `live` != '[]' and `live` != `used` and consult_id = psy_consult.id and `day` = DATE_FORMAT(NOW(),'%Y-%m-%d')) <![CDATA[>]]> 0
                        </if>
                    )
                </when>
                <otherwise>
                    <if test="(serve != null  and serve != '') or (lowPrice != null and highPrice != null)">
                        and id in (
                        SELECT a.consult_id FROM psy_consult_serve a INNER JOIN psy_consult_serve_config b on a.serve_id = b.id WHERE a.consult_id = psy_consult.id
                        <if test="serve != null  and serve != ''"> and b.`mode` = #{serve}</if>
                        <if test="lowPrice != null and highPrice != null">
                            and b.price <![CDATA[>=]]> #{lowPrice} and b.price <![CDATA[<=]]> #{highPrice}
                        </if>
                        GROUP BY a.consult_id
                        )
                    </if>
                </otherwise>
            </choose>
            <if test="(time != null  and time != '') or (days != null and days.size() > 0)">
                and id in (
                    SELECT consult_id FROM psy_consult_work WHERE `status` = 0 and consult_id = psy_consult.id
                    <choose>
                        <when test="time != null and time = '上午'">
                            and `time_start` <![CDATA[>=]]> '06:00' and `time_end` <![CDATA[<=]]> '12:00'
                        </when>
                        <when test="time != null and time = '下午'">
                            and `time_start` <![CDATA[>=]]> '12:00' and `time_end` <![CDATA[<=]]> '18:00'
                        </when>
                        <when test="time != null and time = '晚上'">
                            and `time_start` <![CDATA[>=]]> '18:00' and `time_end` <![CDATA[<=]]> '24:00'
                        </when>
                        <otherwise/>
                    </choose>
                    <if test="days != null and days.size() > 0">
                        and `day` in
                        <foreach collection="days" index="index" item="item" open="(" separator="," close=")">
                            #{item,jdbcType=VARCHAR}
                        </foreach>
                    </if>
                    GROUP BY consult_id
                )
             </if>
        </where>
        order by IF(isnull(new_price),1,0), new_price asc, IF(isnull(price),1,0), price asc, id asc
    </select>

    <update id="tombstonedByIds">
        update psy_consult set del_flag = 1 where id in
        <foreach collection="array" item="item" open="(" separator="," close=")">
            #{item,jdbcType=BIGINT}
        </foreach>
    </update>
    
    <resultMap type="PsyConsult" id="PsyConsultResult">
        <result property="id"    column="id"    />
        <result property="userId"    column="user_id"    />
        <result property="userName"    column="user_name"    />
        <result property="nickName"    column="nicK_name"    />
        <result property="avatar"    column="avatar"    />
        <result property="img"    column="img"    />
        <result property="email"    column="email"    />
        <result property="phonenumber"    column="phonenumber"    />
        <result property="sex"    column="sex"    />
        <result property="tabs"    column="tabs"    />
        <result property="way"    column="way"    />
        <result property="wayStr"    column="way_str"    />
        <result property="info"    column="info"    />
        <result property="detail"    column="detail"    />
        <result property="serve"    column="serve"    />
        <result property="workNum"    column="work_num"    />
        <result property="workTime"    column="work_time"    />
        <result property="workHours"    column="work_hours"    />
        <result property="wxCard"    column="wx_card"    />
        <result property="zxWord"    column="zx_word"    />
        <result property="zxStyle"    column="zx_style"    />
        <result property="notice"    column="notice"    />
        <result property="experience"    column="experience"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="status"    column="status"    />
        <result property="qualification"    column="qualification"    />
        <result property="indexQualification"    column="index_qualification"    />
        <result property="mode"    column="mode"    />
        <result property="city"    column="city"    />
        <result property="province"    column="province"    />
        <result property="genre"    column="genre"    />
        <result property="openId"    column="open_id"    />
        <result property="share"    column="share"    />
        <result property="lang"    column="lang"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
    </resultMap>

    <sql id="selectPsyConsultVo">
        select id, user_id, user_name, nicK_name, mode, city, province, open_id, lang, genre, avatar, img, email, phonenumber, sex, tabs, way, way_str, wx_card, zx_word, zx_style, notice, experience, info, detail, serve, work_num, work_time, work_hours, del_flag, status, qualification, index_qualification, create_by, create_time, update_by, update_time from psy_consult
    </sql>

    <select id="getList" parameterType="PsyConsult" resultMap="PsyConsultResult">
        <include refid="selectPsyConsultVo"/>
        <where>
            <if test="userName != null  and userName != ''"> and user_name like concat('%', #{userName}, '%')</if>
            <if test="userId != null  and userId != ''"> and user_id = #{userId}</if>
            <if test="id != null  and id != ''"> and id = #{id}</if>
            <if test="tabs != null  and tabs != ''"> and tabs = #{tabs}</if>
            <if test="way != null  and way != ''"> and way = #{way}</if>
            <if test="sex != null  and sex != ''"> and sex = #{sex}</if>
            <if test="status != null  and status != ''"> and status = #{status}</if>
            <if test="delFlag != null  and delFlag != ''"> and del_flag = #{delFlag}</if>
        </where>
    </select>
</mapper>